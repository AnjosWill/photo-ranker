# Feature 4.5 ‚Äî Multi-Project Base

> **Objetivo:** Preparar infraestrutura para suportar m√∫ltiplos contests/projetos independentes.

---

## üéØ Objetivo

Criar object store `contests` no IndexedDB, implementar migra√ß√£o autom√°tica e preparar estrutura de dados para m√∫ltiplos projetos.

---

## üì¶ Escopo

### In Scope:
- [x] Object store `contests` no IndexedDB
- [x] Migra√ß√£o autom√°tica (criar contest "default")
- [x] Campo `projectId` em Photo
- [x] Fun√ß√µes CRUD para contests
- [x] √çndices otimizados ('by-project', 'by-phase')
- [x] Testes de migra√ß√£o e queries

### Out of Scope:
- ‚ùå UI de gerenciamento (F4.6)
- ‚ùå Dropdown de sele√ß√£o (F4.6)

---

## üß© Requisitos Funcionais (RF)

### RF1 ‚Äî Object Store
- **RF1.1**: Criar store `contests` com keyPath: 'id'
- **RF1.2**: √çndice `by-date` (createdAt)
- **RF1.3**: √çndice `by-phase` (contestState.phase)

### RF2 ‚Äî Migra√ß√£o Autom√°tica
- **RF2.1**: Detectar primeira vez (DB sem contests)
- **RF2.2**: Criar contest "default" automaticamente
- **RF2.3**: Associar todas as fotos existentes (`projectId = 'default'`)
- **RF2.4**: Transferir contestState para contest.contestState
- **RF2.5**: Mensagem de sucesso: "Dados migrados"

### RF3 ‚Äî CRUD de Contests
- **RF3.1**: `createContest(name, description)` ‚Üí retorna ID
- **RF3.2**: `getAllContests()` ‚Üí retorna array
- **RF3.3**: `getContest(id)` ‚Üí retorna contest
- **RF3.4**: `updateContest(id, data)` ‚Üí atualiza
- **RF3.5**: `deleteContest(id)` ‚Üí remove (+ fotos associadas)

### RF4 ‚Äî Filtro de Fotos por Projeto
- **RF4.1**: `getPhotosByProject(projectId)` ‚Üí retorna fotos do projeto
- **RF4.2**: Grid filtra por `projectId` ativo

---

## üé® Requisitos N√£o Funcionais (RNF)

### RNF1 ‚Äî Performance
- **RNF1.1**: Migra√ß√£o < 100ms para 100 fotos
- **RNF1.2**: Query por projectId < 10ms

### RNF2 ‚Äî Compatibilidade
- **RNF2.1**: Backward compatible (fotos antigas funcionam)
- **RNF2.2**: Sem perda de dados na migra√ß√£o

---

## üìê Estrutura de Dados

### Contest Object:
```javascript
{
  id: string,              // UUID
  name: string,            // "Meu Contest 2025"
  description: string,     // Opcional
  createdAt: number,       // timestamp
  updatedAt: number,       // timestamp
  
  // Estado do contest
  contestState: {
    phase: 'idle' | 'rating' | 'battle' | 'finished',
    
    // Elo scores
    eloScores: {
      [photoId]: number    // ex: { 'photo-123': 1650 }
    },
    
    // Hist√≥rico de batalhas
    battleHistory: Array<{
      photoA: string,
      photoB: string,
      winner: string,
      timestamp: number,
      eloChange: { winner: number, loser: number }
    }>,
    
    // Confronto atual
    currentMatch: {
      photoA: string,
      photoB: string,
      matchNumber: number,
      totalMatches: number
    } | null,
    
    // Campe√£o
    champion: string | null  // photoId
  },
  
  // Configura√ß√µes
  settings: {
    minRatingForBattle: number,  // padr√£o: 5
    kFactor: number              // padr√£o: 32
  }
}
```

### Photo Object (Estendido):
```javascript
{
  id: string,
  thumb: string,
  w: number,
  h: number,
  rating: number,           // Sprint 3
  
  projectId: string,        // ‚¨ÖÔ∏è NOVO (Sprint 4)
  
  _parentId?: string,       // Sprint 2
  _quadrant?: string,       // Sprint 2
  _isSplit?: boolean,       // Sprint 2
  
  uploadedAt: number,
  evaluatedAt?: number      // Sprint 3
}
```

---

## üß± Arquitetura

### Arquivos Novos:
- Nenhum (l√≥gica em `db.js`, `idb.js`)

### Arquivos Modificados:
- `public/scripts/idb.js` - Adicionar store `contests`
- `public/scripts/db.js` - Fun√ß√µes CRUD para contests
- `public/scripts/app.js` - L√≥gica de migra√ß√£o no DOMContentLoaded

---

## üìù Implementa√ß√£o

### idb.js (onupgradeneeded):
```javascript
const DB_VERSION = 2; // ‚¨ÖÔ∏è Incrementar vers√£o

req.onupgradeneeded = (e) => {
  const db = req.result;
  
  // Object store 'photos' (j√° existe)
  if (!db.objectStoreNames.contains('photos')) {
    const photosStore = db.createObjectStore('photos', { keyPath: 'id' });
    photosStore.createIndex('rating', 'rating', { unique: false });
    photosStore.createIndex('parentId', 'parentId', { unique: false });
  }
  
  // ‚¨ÖÔ∏è NOVO: Object store 'contests'
  if (!db.objectStoreNames.contains('contests')) {
    const contestsStore = db.createObjectStore('contests', { keyPath: 'id' });
    contestsStore.createIndex('by-date', 'createdAt', { unique: false });
    contestsStore.createIndex('by-phase', 'contestState.phase', { unique: false });
  }
  
  // Adicionar √≠ndice 'projectId' em 'photos' (se n√£o existir)
  if (db.objectStoreNames.contains('photos')) {
    const transaction = e.target.transaction;
    const photosStore = transaction.objectStore('photos');
    
    if (!photosStore.indexNames.contains('by-project')) {
      photosStore.createIndex('by-project', 'projectId', { unique: false });
    }
  }
};
```

### db.js (Fun√ß√µes CRUD):
```javascript
// Contests
export async function getAllContests() {
  return tx('contests', 'readonly', (s) => {
    return new Promise((resolve, reject) => {
      const req = s.getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  });
}

export async function saveContest(contest) {
  return tx('contests', 'readwrite', (s) => s.put(contest));
}

export async function deleteContest(contestId) {
  return tx('contests', 'readwrite', (s) => s.delete(contestId));
}

// Fotos por projeto
export async function getPhotosByProject(projectId) {
  const allPhotos = await getAllPhotos();
  return allPhotos.filter(p => p.projectId === projectId);
}
```

### Migra√ß√£o (app.js):
```javascript
async function migrateToMultiProject() {
  const contests = await getAllContests();
  
  if (contests.length > 0) {
    return; // J√° migrado
  }
  
  // Criar contest padr√£o
  const defaultContest = {
    id: 'default',
    name: 'Meu Primeiro Contest',
    description: 'Contest padr√£o criado automaticamente',
    createdAt: Date.now(),
    updatedAt: Date.now(),
    contestState: {
      phase: 'rating',
      eloScores: {},
      battleHistory: [],
      currentMatch: null,
      champion: null
    },
    settings: {
      minRatingForBattle: 5,
      kFactor: 32
    }
  };
  
  await saveContest(defaultContest);
  
  // Atualizar fotos com projectId
  const allPhotos = await getAllPhotos();
  for (const photo of allPhotos) {
    if (!photo.projectId) {
      photo.projectId = 'default';
      await savePhotos([photo]);
    }
  }
  
  toast('Dados migrados para sistema de projetos!');
}
```

---

## ‚úÖ Definition of Done

- [ ] Object store `contests` criado
- [ ] √çndices otimizados
- [ ] Migra√ß√£o autom√°tica funcional
- [ ] CRUD de contests implementado
- [ ] Campo `projectId` em Photos
- [ ] 8 casos de teste passando
- [ ] Sem perda de dados na migra√ß√£o
- [ ] Docs atualizadas

---

## üîó Depend√™ncias

- **Depende de:** Nada (infraestrutura)
- **Bloqueia:** F4.6 (Project Manager)

---

**Estimativa:** 2-3 horas  
**Prioridade:** M√©dia (pode ser paralela)  
**Complexidade:** M√©dia

